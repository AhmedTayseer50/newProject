<!-- src/app/admin/course-editor/course-editor.component.html -->
<div class="container py-4" dir="rtl">
  <a routerLink="/admin/dashboard" class="btn btn-link ps-0 mb-3"
    >&larr; رجوع للوحة التحكم</a
  >

  <!-- ✅ وضع القائمة: يظهر فقط عندما لا يوجد courseId -->
  <ng-container *ngIf="!courseId">
    <div class="d-flex align-items-center mb-3">
      <h3 class="mb-0">كل الكورسات</h3>
      <button
        class="btn btn-outline-secondary btn-sm ms-auto"
        (click)="loadCoursesList()"
        [disabled]="loading"
      >
        تحديث
      </button>
    </div>

    <div class="card mb-4">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>العنوان</th>
              <th style="width: 120px">السعر</th>
              <th style="width: 110px">الحالة</th>
              <th style="width: 220px">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of courses">
              <td>{{ c.title || "بدون عنوان" }}</td>
              <td>{{ c.price ?? 0 }}</td>
              <td>
                <span
                  class="badge"
                  [class.text-bg-success]="c.published"
                  [class.text-bg-secondary]="!c.published"
                >
                  {{ c.published ? "منشور" : "مسودّة" }}
                </span>
              </td>
              <td class="d-flex gap-2">
                <a
                  class="btn btn-sm btn-primary"
                  [routerLink]="['/admin/course-editor', c.id]"
                  >تعديل</a
                >
                <button
                  class="btn btn-sm btn-outline-danger"
                  (click)="deleteCourseFromList(c.id)"
                >
                  حذف
                </button>
              </td>
            </tr>
            <tr *ngIf="!courses.length">
              <td colspan="4" class="text-muted text-center py-3">
                لا توجد كورسات بعد
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <h4 class="mb-2">إضافة كورس جديد</h4>
  </ng-container>

  <!-- ✅ وضع التعديل: يظهر العنوان عند وجود courseId -->
  <h3 class="mb-3" *ngIf="courseId">تعديل كورس</h3>

  <!-- رسائل عامة -->
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
  <div *ngIf="loading" class="alert alert-info">جارٍ المعالجة…</div>

  <!-- نموذج الكورس (يُستخدم في الإنشاء أو التعديل) -->
  <form [formGroup]="courseForm" (ngSubmit)="saveCourse()" class="card mb-4">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">عنوان الكورس</label>
        <input
          formControlName="title"
          class="form-control"
          placeholder="مثال: أساسيات الصحة النفسية"
        />
      </div>

      <div class="mb-3">
        <label class="form-label">الوصف</label>
        <textarea
          formControlName="description"
          rows="3"
          class="form-control"
        ></textarea>
      </div>

      <div class="row g-3">
        <div class="col-sm-4">
          <label class="form-label">السعر</label>
          <input type="number" formControlName="price" class="form-control" />
        </div>
        <div class="col-sm-4">
          <label class="form-label">التصنيف</label>
          <input
            formControlName="categoryId"
            class="form-control"
            placeholder="cat_intro"
          />
        </div>
        <div class="col-sm-4 form-check mt-4">
          <input
            id="pub"
            type="checkbox"
            class="form-check-input"
            formControlName="published"
          />
          <label for="pub" class="form-check-label">نشر الكورس</label>
        </div>
      </div>

      <div class="mb-3 mt-3">
        <label class="form-label">رابط الصورة المصغّرة (اختياري)</label>
        <input
          formControlName="thumbnail"
          class="form-control"
          placeholder="https://..."
        />
      </div>

      <!-- ✅ الحقول الإضافية للعرض التسويقي -->
      <hr />

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">مدة البرنامج</label>
          <input
            formControlName="programDuration"
            class="form-control"
            placeholder="مثال: ٤ أسابيع / شهر"
          />
        </div>
        <div class="col-md-6">
          <label class="form-label">لمن هذا الكورس؟</label>
          <input
            formControlName="targetAudience"
            class="form-control"
            placeholder="مثال: لأي شخص يعاني من..."
          />
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">الهدف من الدراسة</label>
        <div class="row g-2">
          <div class="col-md-4">
            <input
              formControlName="goalTitle"
              class="form-control"
              placeholder="عنوان مختصر"
            />
          </div>
          <div class="col-md-8">
            <textarea
              formControlName="goalDescription"
              rows="2"
              class="form-control"
              placeholder="وصف الهدف بالتفصيل"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">المدة المتوقعة للدراسة</label>
        <div class="row g-2">
          <div class="col-md-4">
            <input
              formControlName="expectedStudyTimeTitle"
              class="form-control"
              placeholder="مثال: ٣ ساعات أسبوعيًا"
            />
          </div>
          <div class="col-md-8">
            <textarea
              formControlName="expectedStudyTimeDescription"
              rows="2"
              class="form-control"
              placeholder="تفاصيل المدة المتوقعة"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">الخبرات السابقة المطلوبة</label>
        <div class="row g-2">
          <div class="col-md-4">
            <input
              formControlName="prerequisitesTitle"
              class="form-control"
              placeholder="مثال: لا يحتاج خبرة سابقة"
            />
          </div>
          <div class="col-md-8">
            <textarea
              formControlName="prerequisitesDescription"
              rows="2"
              class="form-control"
              placeholder="تفاصيل المتطلبات إن وجدت"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">رابط الفيديو التعريفي</label>
        <input
          formControlName="introVideoUrl"
          class="form-control"
          placeholder="https://youtube.com/embed/..."
        />
      </div>

      <div class="mt-4">
        <label class="form-label">رأي أحد المتدربين</label>
        <div class="row g-2">
          <div class="col-md-3">
            <input
              formControlName="testimonialName"
              class="form-control"
              placeholder="الاسم"
            />
          </div>
          <div class="col-md-3">
            <input
              formControlName="testimonialProblem"
              class="form-control"
              placeholder="المشكلة قبل الكورس"
            />
          </div>
          <div class="col-md-4">
            <input
              formControlName="testimonialText"
              class="form-control"
              placeholder="وصف التجربة / التغيير"
            />
          </div>
          <div class="col-md-2">
            <input
              formControlName="testimonialRating"
              class="form-control"
              placeholder="التقييم (مثال: 5/5)"
            />
          </div>
        </div>
      </div>

      <div class="mt-4">
        <label class="form-label">الخطط السعرية</label>
        <div class="row g-2">
          <div class="col-md-4">
            <input
              formControlName="pricingBasic"
              class="form-control"
              placeholder="الخطة الأساسية"
            />
          </div>
          <div class="col-md-4">
            <input
              formControlName="pricingGroup"
              class="form-control"
              placeholder="خطة المتابعة الجماعية"
            />
          </div>
          <div class="col-md-4">
            <input
              formControlName="pricingPremium"
              class="form-control"
              placeholder="الخطة المميزة"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ نفس جزء أسماء الدروس كما هو -->
    <div class="card mt-3">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span>أسماء الدروس (للعرض فقط)</span>
        <button
          type="button"
          class="btn btn-sm btn-outline-primary"
          (click)="addLectureName()"
        >
          + إضافة درس
        </button>
      </div>
      <ul class="list-group list-group-flush">
        <li
          class="list-group-item"
          *ngFor="let ctrl of lectureNames.controls; let i = index"
        >
          <div class="d-flex gap-2">
            <input
              class="form-control"
              [formControl]="ctrl"
              placeholder="اسم الدرس رقم {{ i + 1 }}"
            />
            <button
              type="button"
              class="btn btn-outline-danger"
              (click)="removeLectureName(i)"
              aria-label="حذف"
            >
              حذف
            </button>
          </div>
        </li>
        <li class="list-group-item" *ngIf="lectureNames.length === 0">
          لا توجد أسماء دروس — اضغط “+ إضافة درس”.
        </li>
      </ul>
    </div>

    <div class="card-footer d-flex gap-2">
      <button class="btn btn-success" [disabled]="loading">
        {{ courseId ? "حفظ التعديلات" : "إنشاء الكورس" }}
      </button>
      <button
        *ngIf="courseId"
        type="button"
        class="btn btn-danger ms-auto"
        (click)="deleteCourse()"
        [disabled]="loading"
      >
        حذف الكورس
      </button>
    </div>
  </form>

  <!-- إدارة الدروس: تظهر فقط في وضع التعديل -->
  <ng-container *ngIf="courseId">
    <h4 class="mb-3">الدروس</h4>

    <!-- نموذج الدرس -->
    <form [formGroup]="lessonForm" (ngSubmit)="saveLesson()" class="card mb-3">
      <div class="card-body row g-3">
        <input type="hidden" formControlName="id" />
        <div class="col-md-5">
          <label class="form-label">عنوان الدرس</label>
          <input
            formControlName="title"
            class="form-control"
            placeholder="مقدمة"
          />
        </div>
        <div class="col-md-2">
          <label class="form-label">ترتيب</label>
          <input
            type="number"
            formControlName="lessonIndex"
            class="form-control"
            min="1"
          />
        </div>
        <div class="col-md-3">
          <label class="form-label">المنصة</label>
          <select formControlName="videoProvider" class="form-select">
            <option value="youtube">YouTube</option>
          </select>
        </div>
        <div class="col-md-5">
          <label class="form-label">YouTube videoId</label>
          <input
            formControlName="videoRef"
            class="form-control"
            placeholder="مثال: dQw4w9WgXcQ"
          />
          <div class="form-text">ارفع الفيديو Unlisted وخُد الـ videoId من الرابط.</div>
        </div>
      </div>
      <div class="card-footer d-flex gap-2">
        <button class="btn btn-primary" [disabled]="loading">
          {{ lessonForm.value.id ? "تحديث الدرس" : "إضافة الدرس" }}
        </button>
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="resetLessonForm()"
        >
          تفريغ الحقول
        </button>
      </div>
    </form>

    <!-- قائمة الدروس -->
    <div class="list-group">
      <div
        class="list-group-item d-flex justify-content-between align-items-center"
        *ngFor="let l of lessons"
      >
        <div>
          <strong>الدرس {{ l.lessonIndex }}:</strong> {{ l.title }}
          <div class="text-muted small" *ngIf="l.videoRef">
            فيديو مضبوط
          </div>
        </div>
        <div class="btn-group">
          <button
            class="btn btn-sm btn-outline-primary"
            (click)="editLesson(l)"
          >
            تعديل
          </button>
          <button
            class="btn btn-sm btn-outline-danger"
            (click)="deleteLesson(l.id)"
          >
            حذف
          </button>
        </div>
      </div>
    </div>
  </ng-container>
</div>
